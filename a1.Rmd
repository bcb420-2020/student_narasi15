---
title: "Assignment 1: Data Set Selection and Initial Processing"
author: "Priyanka Narasimhan"
output: html
---

# This R Notebook will provide insight on the initial preparation and analysis of the dataset GSE136864. 
# Resources: Sample code from lectures 3 & 4, and RPR-GEO2R.R file from Prof. Streipe was used.

# 0 - Install and load additional packages like BiocManager, BioBase, & GEOquery
```{r}
rm(list = ls())
if (! requireNamespace("BiocManager", quietly = TRUE)) {
  install.packages("BiocManager")
}
if (! requireNamespace("Biobase", quietly = TRUE)) {
  BiocManager::install("Biobase")
}
if (! requireNamespace("GEOquery", quietly = TRUE)) {
  BiocManager::install("GEOquery")
}

# Load
library(BiocGenerics)
library(Biobase)
library(GEOquery)
```

# 1 - Download the dataset from GEO
```{r}
gset <- GEOquery::getGEO("GSE136864", GSEMatrix =TRUE)
# Some additional info:
length(gset) # the length is 1
edata <- gset[[1]]
edata # This is our expression matrix
# Our phenodata returns a dataframe that shows our 17 GEO samples, and 49 variable (column) labels
names = (pData(edata))
names
```

# Download Supplementary file(s), there is only 1 
```{r}
supfile <- NULL
sfilename="GSE136864_elf1_counts_matrix.txt.gz" 
# Don't download if supp. file already exists
if (!file.exists(sfilename)) {
    supfile <- getGEOSuppFiles('GSE136864')
 } 
fnames = rownames(supfile)
fnames
```

# 2 - Assessing the Dataset 
Uniprot tells us: ETS-related transcription factor Elf-1 is a protein, gene name is ELF1
Definition 1: A transcription factor is a protein that controls the rate of transcription
Definition 2: A type I interferon (IFN) is a subgroup of proteins that help regulate the activity of the immune system 

This particular dataset studies the transcription factor ELF1, and it's effect in inbihiting replication of viral
infections (like influenza), independent of type I interferons. 
I was particularly interested in this dataset due to recent events and outbreaks of the corona virus. Hence I wanted to choose a topic related to viral infections and/or human body immune system. 
 
# Some general information about this platform:

```{r}
gse <- getGEO("GSE136864", GSEMatrix=FALSE)
current_gpl <- names(GPLList(gse))[1]
current_gpl_info <- Meta(getGEO(current_gpl))
```

**Platform title:** `r current_gpl_info$title`
**Submission date:** `r current_gpl_info$submission_date`
**Last updated date:** `r current_gpl_info$last_update_date`
**Organism:** `r current_gpl_info$organism`
**Number of GEO datasets that use this technology:** `r length(current_gpl_info$series_id)`
**Number of GEO samples that use this technology:** `r length(current_gpl_info$sample_id)`

# Experimental Design:

A549 cells (which are found in lung tissue), were used in the experiment. These cells were either:
- not-transduced 
- or transduced with empty vector, ELF1-WT, or ELF1-R8A mutant. 
In addition, indicated cultures were stimulated with interferon beta for 6 hours or 48 hours. 
All samples were harvested simultaneously and analyzed by RNA-Seq

# Get some data about the supplementary files
```{r}
sfiles = getGEOSuppFiles('GSE136864')
counts = read.delim(rownames(sfiles)[1],header=TRUE, check.names = FALSE)
head(counts)
```

```{r}
dim(counts) # returns [1] 63678    18
```

```{r}
# Use column 1 in the 'counts' table as the rownames
rownames(counts) <- counts[, 1]
counts

# check for any duplicate rownames, there are no duplicate row names!
any(duplicated(rownames(counts)))
```

```{r}
# Define groups, using 1, 3, and 2 token after split string
# "Transduced" column - either empty, ELF1, cell or R8A
# "trial_num" - pretty self explanatory
# "mock_or_IFN" - mock means no stimulation with IFN
samples <- data.frame(lapply(colnames(counts)[2:18],
                             FUN = function(x) {
                               unlist(strsplit(x, split="_"))[c(1, 3, 2)]
                             }))
colnames(samples) <- colnames(counts)[2:18]
rownames(samples) <- c("Transduced", "trial_num", "mock_or_IFN")
samples <- data.frame(t(samples))
samples
```

# 3 - Map to HUGO symbols
Our dataset curently contains 63,678 Ensembl (ENSG) genes which need to be mapped to HUGO symbols.
```{r}
# install and load the necessary libraries
if (! requireNamespace("org.Hs.eg.db", quietly = TRUE)) {
    BiocManager::install("org.Hs.eg.db")
}
suppressMessages(library("AnnotationDbi"))
suppressMessages(library("org.Hs.eg.db"))

# Map to HUGO symbols and add as a new column 'gname' to our table
if (!any(colnames(counts) == 'gname')) {
  counts <- cbind(counts, gname=mapIds(org.Hs.eg.db,keys=rownames(counts),column="SYMBOL",keytype="ENSEMBL",multiVals="first"))
}

# Now check for duplicates in newly added gname column
any(duplicated(counts$gname)) # Yes there are duplicates!
counts
```

# 4 - Clean the data
We want to do some filtering and cleaning up the data before moving onto normalization
```{r}
# We have over 63,000 genes to account for, but genes with low counts should be removed prior to downstream analysis, because from a statistical point of view, low counts are not feasible to make reliable judgements.
# Based on edgeR recommendations, we shall keep our minumum count as 3, since there are at least 3 samples for each group. 

library(edgeR)
cpms = cpm(counts[,2:18])
rownames(cpms) <- counts[,1]
keep = rowSums(cpms >1) >=3
counts_filtered <- counts[keep,]

dim(counts_filtered) # returns [1] 14601    19

# Number of genes that are 'NA', that don't map to anything
no_gene_counts <- sum(is.na(counts_filtered$gname))
no_gene_counts # returns [1] 1205

# Discussion ...
# - Even if a gene is labelled as 'NA' we still keep it, because it has nothing to do with the validity of the gene count. It just means that a gene symbol needs to be requested.

```


# 5 - Normalize the data

# References
https://www.biostars.org/p/239681/
https://www.bioconductor.org/packages/release/workflows/vignettes/RnaSeqGeneEdgeRQL/inst/doc/edgeRQL.html#filtering-to-remove-low-counts




